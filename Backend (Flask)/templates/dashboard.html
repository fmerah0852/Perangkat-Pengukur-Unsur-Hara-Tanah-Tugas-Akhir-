<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPK Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
        h1 { text-align:center; color:#333; }
        table { border-collapse:collapse; width:100%; margin-top:20px; }
        th, td { border:1px solid #ccc; padding:8px; text-align:center; }
        th { background-color:#4CAF50; color:white; }
        .chart-container { width:90%; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <h1>ðŸŒ¾ NPK Monitoring Dashboard</h1>

    <div class="chart-container">
        <canvas id="npkChart"></canvas>
    </div>

    <h2>Data Pengukuran Terbaru</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Device</th>
                <th>Waktu</th>
                <th>N</th>
                <th>P</th>
                <th>K</th>
                <th>Latitude</th>
                <th>Longitude</th>
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
            <tr>
                <td>{{ row.id }}</td>
                <td>{{ row.device_id }}</td>
                <td>{{ row.time_str }}</td>
                <td>{{ "%.1f"|format(row.n) }}</td>
                <td>{{ "%.1f"|format(row.p) }}</td>
                <td>{{ "%.1f"|format(row.k) }}</td>
                <td>{{ row.lat }}</td>
                <td>{{ row.lon }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        const npkData = {{ data | tojson }};
        const labels = npkData.map(r => r.time_str).reverse();
        const nValues = npkData.map(r => r.n).reverse();
        const pValues = npkData.map(r => r.p).reverse();
        const kValues = npkData.map(r => r.k).reverse();

        new Chart(document.getElementById('npkChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Nitrogen (N)', data: nValues, borderColor: 'red', fill:false },
                    { label: 'Phosphorus (P)', data: pValues, borderColor: 'blue', fill:false },
                    { label: 'Kalium (K)', data: kValues, borderColor: 'green', fill:false }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'top' } },
                scales: { x: { ticks: { maxTicksLimit: 10 } } }
            }
        });
    </script>
</body>
</html>
